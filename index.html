<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>КЛАДОВАЯ • Библиотека</title>
<style>
  :root{
    --bg:#FAFAFA; --text:#111; --muted:#666; --accent:#7A5DFF;
    --card:#fff; --border:#e6e6e8; --shadow:0 6px 24px rgba(0,0,0,.06);
    --radius:16px; --space:14px; --mono:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
  }
  [data-theme="dark"]{
    --bg:#121315; --text:#F6F7FB; --muted:#B0B3BD; --accent:#7A9BFF;
    --card:#1A1C1F; --border:#2A2D33; --shadow:none;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:400 16px/1.6 system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial,"Noto Sans",sans-serif;}
  a{color:inherit;text-decoration:none}
  .toolbar{
    position:sticky;top:0;z-index:10;backdrop-filter:saturate(1.2) blur(10px);
    background:color-mix(in oklab, var(--card) 85%, transparent);
    border-bottom:1px solid var(--border);
  }
  .toolbar-inner{max-width:1200px;margin:0 auto;display:flex;gap:10px;align-items:center;padding:10px var(--space)}
  .logo{display:flex;align-items:center;gap:10px;font-weight:700}
  .logo svg{width:22px;height:22px}
  .spacer{flex:1}
  .toggle{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:var(--card)}
  main{max-width:1200px;margin:0 auto;padding:var(--space)}
  .layout{display:grid;grid-template-columns:280px 1fr;gap:var(--space)}
  .panel{
    background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);
  }
  .panel .hd{padding:12px var(--space);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
  .panel .hd .title{font-weight:700}
  .panel .bd{padding:12px var(--space)}
  .muted{color:var(--muted)}
  .booklist{display:grid;gap:10px}
  .book{display:flex;gap:10px;align-items:center;padding:10px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer}
  .book:hover{outline:2px solid color-mix(in oklab, var(--accent) 28%, transparent)}
  .book .meta{font-size:13px;color:var(--muted)}
  .toc{display:block;margin:0;padding:0;list-style:none}
  .toc li{margin:4px 0}
  .toc button{
    width:100%;text-align:left;border:1px solid var(--border);background:var(--card);color:inherit;
    padding:8px 10px;border-radius:10px;cursor:pointer;
  }
  .toc button:hover{border-color:color-mix(in oklab, var(--accent) 35%, var(--border))}
  .content{min-height:60vh}
  .content h1{margin:0 0 6px;font-size:22px}
  .content .chapter-pos{font:500 12px/1 var(--mono);color:var(--muted);margin-bottom:14px}
  .content p{margin:0 0 1em}
  .content pre, .content code{font-family:var(--mono)}
  .empty{padding:16px;border:1px dashed var(--border);border-radius:12px;color:var(--muted);background:color-mix(in oklab, var(--card) 80%, transparent)}
  .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:color-mix(in oklab, var(--accent) 14%, transparent);color:inherit;border:1px solid var(--border);font-size:12px}
  .footer{max-width:1200px;margin:24px auto;padding:0 var(--space);color:var(--muted);font-size:13px}
  @media (max-width:860px){
    .layout{grid-template-columns:1fr}
    .panel .bd{padding:10px}
  }
</style>
</head>
<body>
  <header class="toolbar" role="banner" aria-label="Верхняя панель">
    <div class="toolbar-inner">
      <div class="logo">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H9l-5 3V7Z" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>КЛАДОВАЯ • Библиотека</span>
      </div>
      <div class="spacer"></div>
      <label class="toggle" title="Тема">
        <input id="themeToggle" type="checkbox" aria-label="Тёмная тема">
        <span class="muted">Тёмная тема</span>
      </label>
    </div>
  </header>

  <main role="main">
    <div class="layout">
      <!-- Левая колонка: книги + оглавление -->
      <section class="panel" aria-labelledby="lib-h">
        <div class="hd"><div class="title" id="lib-h">Библиотека</div></div>
        <div class="bd">
          <div id="books" class="booklist"></div>
          <div id="booksEmpty" class="empty hidden">Нет книг. Добавьте пути к вашим JSON-файлам в массив <b>BOOK_SOURCES</b> или используйте <b>library.json</b> в корне репозитория.</div>

          <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">

          <div class="title" style="margin-bottom:8px">Оглавление</div>
          <ul id="toc" class="toc"></ul>
          <div id="tocEmpty" class="empty">Выберите книгу, чтобы увидеть главы.</div>
        </div>
      </section>

      <!-- Правая колонка: контент главы -->
      <section class="panel" aria-labelledby="content-h">
        <div class="hd"><div class="title" id="content-h">Текст главы</div> <span id="badge" class="pill" style="margin-left:10px;display:none"></span></div>
        <div class="bd content" id="content">
          <div class="empty">Нажмите на главу слева, чтобы открыть текст.</div>
        </div>
      </section>
    </div>
  </main>

  <div class="footer">Файлы читаются прямо в приложении. Пользовательские загрузки отключены.</div>

<script>
;(()=>{
  /* ========= НАСТРОЙКА ИСТОЧНИКОВ =========
     Вариант A: перечислите файлы здесь.
     Пример: { title:"Откровение №1", url:"./otkrovenie_1.json" }
     Вариант B: положите рядом library.json: [{ "title": "...", "url": "./path.json" }, ...]
  ========================================= */
  const BOOK_SOURCES = [
    { title: "Откровение №1", url: "./otkrovenie_1.json" } // ← добавляйте сюда следующие файлы
    // { title: "Откровение №2", url: "./otkrovenie_2.json" },
  ];
  const TRY_LIBRARY_JSON = true; // попытается подхватить /library.json, если он есть

  /* --------------- УТИЛИТЫ --------------- */
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const escapeHtml = (s='')=> s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  const byId = new Map(); // content_id → книга
  let currentBook = null;

  // Тема
  const themeToggle = $('#themeToggle');
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.body.setAttribute('data-theme', savedTheme==='dark'?'dark':'light');
  themeToggle.checked = savedTheme==='dark';
  themeToggle.addEventListener('change', ()=>{
    const v = themeToggle.checked?'dark':'light';
    document.body.setAttribute('data-theme', v);
    localStorage.setItem('theme', v);
  });

  /* ---------- ЗАГРУЗКА КНИГ ---------- */
  async function loadBooks(){
    let list = [...BOOK_SOURCES];
    if (TRY_LIBRARY_JSON){
      try{
        const res = await fetch('./library.json', {cache:'no-store'});
        if (res.ok){
          const extra = await res.json();
          if (Array.isArray(extra)) list = extra.concat(list);
        }
      }catch{/* игнор */}
    }
    // Уникализировать по URL
    const seen = new Set(); list = list.filter(x=>{ if(!x?.url) return false; if (seen.has(x.url)) return false; seen.add(x.url); return true; });

    const books = [];
    for (const row of list){
      try{
        const res = await fetch(row.url, {cache:'no-store'});
        if (!res.ok) throw new Error('http '+res.status);
        const json = await res.json();
        books.push(normalize(json, row));
      }catch(e){
        console.warn('Не удалось загрузить', row.url, e);
      }
    }
    return books;
  }

  function normalize(json, src){
    // Поддерживаем несколько вариантов поля с главами и текстом
    // ожидаемые поля:
    //   content_id: string
    //   title: string
    //   pages?: number
    //   chapters: [{ title, start_page?, content?, subsections?: [{ title, start_page?, content? }] }]
    const title = json.title || json.book_title || src.title || 'Без названия';
    const id = json.content_id || ('auto-'+Math.random().toString(36).slice(2));
    const chapters = Array.isArray(json.chapters) ? json.chapters : [];

    // Гарантируем минимальные поля глав
    const safeChapters = chapters.map((ch, i)=>({
      idx: i,
      title: ch?.title || `Глава ${i+1}`,
      start_page: ch?.start_page ?? null,
      content: typeof ch?.content === 'string' ? ch.content : (Array.isArray(ch?.paragraphs) ? ch.paragraphs.join('\n\n') : null),
      subsections: Array.isArray(ch?.subsections) ? ch.subsections.map((s,j)=>({
        idx: j,
        title: s?.title || `Раздел ${i+1}.${j+1}`,
        start_page: s?.start_page ?? null,
        content: typeof s?.content === 'string' ? s.content : (Array.isArray(s?.paragraphs) ? s.paragraphs.join('\n\n') : null)
      })) : []
    }));

    const book = {
      content_id: id,
      title,
      pages: json.pages ?? null,
      chapters: safeChapters,
      source_url: src.url
    };
    byId.set(id, book);
    return book;
  }

  /* ---------- РЕНДЕР ЛЕВОЙ КОЛОНКИ ---------- */
  function renderBooks(books){
    const host = $('#books');
    host.innerHTML = '';
    if (!books.length){ $('#booksEmpty').classList.remove('hidden'); return; }
    $('#booksEmpty').classList.add('hidden');

    books.forEach(b=>{
      const el = document.createElement('button');
      el.className = 'book';
      el.innerHTML = `
        <div style="flex:1;min-width:0">
          <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escapeHtml(b.title)}</div>
          <div class="meta">глав: ${b.chapters.length}${b.pages?` • стр. ${b.pages}`:''}</div>
        </div>
      `;
      el.addEventListener('click', ()=>{ currentBook = b; renderTOC(b); clearContent(); });
      host.appendChild(el);
    });
  }

  function renderTOC(book){
    const toc = $('#toc'); const empty = $('#tocEmpty');
    toc.innerHTML = '';
    if (!book || !book.chapters.length){ empty.classList.remove('hidden'); return; }
    empty.classList.add('hidden');

    book.chapters.forEach((ch, i)=>{
      const li = document.createElement('li');
      const btn = document.createElement('button');
      btn.innerHTML = `${escapeHtml(ch.title)} <span class="muted" style="float:right">${ch.start_page?`стр. ${ch.start_page}`:''}</span>`;
      btn.addEventListener('click', ()=> openChapter(book, ch));
      li.appendChild(btn);

      // Если есть подразделы — рендерим списком
      if (Array.isArray(ch.subsections) && ch.subsections.length){
        const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='6px 0 0 12px';
        ch.subsections.forEach(ss=>{
          const li2 = document.createElement('li'); const b2 = document.createElement('button');
          b2.style.marginTop='6px';
          b2.innerHTML = `${escapeHtml(ss.title)} <span class="muted" style="float:right">${ss.start_page?`стр. ${ss.start_page}`:''}</span>`;
          b2.addEventListener('click', ()=> openSubsection(book, ch, ss));
          ul.appendChild(li2).appendChild(b2);
        });
        li.appendChild(ul);
      }

      toc.appendChild(li);
    });
  }

  /* ---------- ОТКРЫТИЕ ГЛАВ/РАЗДЕЛОВ ---------- */
  function clearContent(){
    $('#content').innerHTML = `<div class="empty">Выберите главу слева, чтобы открыть текст.</div>`;
    $('#badge').style.display = 'none';
  }

  function openChapter(book, ch){
    renderContent({
      heading: ch.title,
      pos: ch.start_page ? `стр. ${ch.start_page}` : '',
      text: ch.content
    }, book);
  }

  function openSubsection(book, ch, ss){
    renderContent({
      heading: `${ch.title} — ${ss.title}`,
      pos: ss.start_page ? `стр. ${ss.start_page}` : (ch.start_page?`гл. стр. ${ch.start_page}`:''),
      text: ss.content
    }, book);
  }

  function renderContent({heading, pos, text}, book){
    const host = $('#content'); host.innerHTML = '';
    const badge = $('#badge'); badge.textContent = book?.title || ''; badge.style.display = book ? 'inline-flex':'none';

    const h1 = document.createElement('h1'); h1.textContent = heading || 'Без названия';
    const meta = document.createElement('div'); meta.className = 'chapter-pos'; meta.textContent = pos || '';
    const body = document.createElement('div');

    if (text && typeof text === 'string'){
      // Разбиваем на абзацы по пустой строке
      text.trim().split(/\n{2,}/).forEach(p=>{
        const q = p.trim();
        if (!q) return;
        const P = document.createElement('p'); P.textContent = q; body.appendChild(P);
      });
    } else {
      body.innerHTML = `<div class="empty">Для этой главы в JSON нет текстового поля <b>content</b> (или <b>paragraphs</b>). Добавьте его — и текст появится здесь автоматически.</div>`;
    }

    host.appendChild(h1);
    if (meta.textContent) host.appendChild(meta);
    host.appendChild(body);
    window.scrollTo({top:0, behavior:'smooth'});
  }

  /* ---------- BOOT ---------- */
  (async function boot(){
    const books = await loadBooks();
    renderBooks(books);
    // Автоматически выбрать первую книгу (если есть)
    if (books[0]){ currentBook = books[0]; renderTOC(currentBook); }
  })();

})();
</script>
</body>
</html>
