<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>КЛАДОВАЯ • Библиотека</title>

<!-- Telegram Mini App SDK (опционально) -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
  :root{
    --bg:#F2E8D9; --bg-grad: linear-gradient(180deg,#F7EEDF 0%, #EFE1CE 100%);
    --text:#2B2622; --accent:#B88B5A; --hint:#7b6e64;
    --card:#FFF9F0; --border:#E8DAC6; --shadow:0 10px 30px rgba(94,62,24,.08);
    --toolbar: color-mix(in oklab, #FFF9F0 85%, transparent);
  }
  [data-theme="light"] { --bg:#FAFAFA; --bg-grad: linear-gradient(180deg,#FFFFFF 0%, #F6F7F9 100%); --text:#111; --accent:#3390EC; --card:#fff; --border:#e5e7eb; --toolbar:#ffffffcc; }
  [data-theme="dark"]  { --bg:#1C1C1D; --bg-grad: linear-gradient(180deg,#1C1C1D,#131314); --text:#fff; --accent:#3390EC; --card:#202022; --border:#2a2a2b; --toolbar:#1c1c1dcc; }

  html,body{height:100%}
  body{margin:0;color:var(--text);background:var(--bg-grad);font:400 16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Noto Sans",sans-serif;-webkit-font-smoothing:antialiased}
  *{box-sizing:border-box}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  .toolbar{position:sticky;top:0;z-index:30;backdrop-filter:saturate(1.2) blur(8px);background:var(--toolbar);border-bottom:1px solid var(--border)}
  .toolbar-inner{display:flex;align-items:center;gap:8px;min-height:60px;padding:8px 16px}
  .logo{display:flex;align-items:center;gap:10px;font-weight:700}
  .grid{display:grid;gap:12px}
  .grid.cards{grid-template-columns:repeat(auto-fill,minmax(260px,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
  .title{font-weight:700}
  .muted{color:var(--hint)}
  .btn,.btn-ghost{border-radius:14px;padding:10px 14px;border:1px solid var(--border);background:var(--card);cursor:pointer}
  .btn-primary{background:var(--accent);color:#fff;border-color:transparent}
  .search{display:flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--border);border-radius:12px;background:var(--card)}
  input,select{background:transparent;color:inherit;border:1px solid var(--border);border-radius:12px;padding:10px 12px;outline:none}
  .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:8px 12px;background:var(--card);border:1px solid var(--border)}
  .toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#111c;color:#fff;padding:10px 14px;border-radius:10px;z-index:80}
  .hidden{display:none!important}
  .toc{max-height:60vh;overflow:auto}
  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  @media (max-width:640px){.container{padding:12px}.toolbar-inner{min-height:56px}.grid.cards{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}}
</style>
</head>
<body>
  <header class="toolbar" role="banner">
    <div class="toolbar-inner container">
      <div class="logo" id="appLogo" title="На главную" role="link" tabindex="0">
        <svg viewBox="0 0 24 24" width="22" height="22" fill="none" aria-hidden="true"><path d="M4 7a3 3 0 0 1 3-3h10a3 3 0 0 1 3 3v10a3 3 0 0 1-3 3H9l-5 3V7Z" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>КЛАДОВАЯ • Библиотека</span>
      </div>
      <div class="spacer" style="flex:1"></div>
      <div class="search" role="search">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="m21 21l-4.35-4.35m1.35-5.65a7 7 0 1 1-14 0a7 7 0 0 1 14 0Z"/></svg>
        <input id="searchInput" type="search" placeholder="Поиск по библиотеке…" aria-label="Поиск по библиотеке"/>
      </div>
      <div class="menu" id="mainMenu" style="position:relative">
        <button class="btn-ghost" aria-haspopup="menu" aria-expanded="false" title="Меню">☰</button>
        <div class="menu-list card" role="menu" aria-label="Главное меню" style="position:absolute;right:0;top:calc(100% + 8px);display:none;min-width:260px">
          <label class="btn" role="menuitem" for="fileInput">Импорт JSON</label>
          <button class="btn" role="menuitem" id="btnAddUrl">Добавить по URL</button>
          <button class="btn" role="menuitem" id="btnLoadIndex">Загрузить library.json</button>
          <hr style="border:none;border-top:1px solid var(--border);margin:8px 0"/>
          <button class="btn" role="menuitem" id="btnSettings">Настройки</button>
          <button class="btn" role="menuitem" id="btnClearAll">Очистить все данные…</button>
        </div>
      </div>
      <input id="fileInput" type="file" accept="application/json,.json" hidden multiple />
    </div>
  </header>

  <main id="app" class="container" role="main">
    <section id="view-library" class="grid" aria-labelledby="lib-heading">
      <h2 id="lib-heading" class="sr-only">Библиотека</h2>

      <div class="grid" style="gap:16px">
        <div class="card">
          <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
            <div class="title">Библиотека</div>
            <div class="pill">
              <label class="btn" for="fileInput">Импорт JSON</label>
              <button class="btn" id="btnAddUrl2">URL</button>
              <button class="btn" id="btnLoadIndex2">library.json</button>
            </div>
          </div>
          <div id="libraryList" class="grid cards" style="margin-top:8px"></div>
          <div id="emptyLibraryNote" class="muted" style="margin-top:8px">Добавьте JSON-файлы с книгами.</div>
        </div>

        <div class="card">
          <div style="display:flex;align-items:center;gap:12px;justify-content:space-between">
            <div class="title">Оглавление / детали</div>
            <div class="muted">просмотр без читалки</div>
          </div>
          <div id="details" class="toc muted">Выберите книгу, чтобы увидеть главы и подразделы.</div>
        </div>
      </div>
    </section>

    <section id="view-settings" class="hidden" aria-labelledby="settings-heading">
      <h2 id="settings-heading" class="title">Настройки</h2>
      <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:12px">
        <div class="card">
          <div class="title" style="margin-bottom:8px">Тема</div>
          <div class="grid" style="grid-template-columns:repeat(3,minmax(0,1fr))">
            <label><input type="radio" name="theme" value="auto"> Авто</label>
            <label><input type="radio" name="theme" value="light"> Светлая</label>
            <label><input type="radio" name="theme" value="dark"> Тёмная</label>
          </div>
        </div>
        <div class="card">
          <div class="title" style="margin-bottom:8px">Данные</div>
          <div class="grid">
            <button class="btn" id="btnClearAll2">Очистить библиотеку…</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast hidden" role="status" aria-live="polite"></div>

  <dialog id="dlgUrl">
    <form method="dialog" style="min-width:min(92vw,520px)">
      <h3 class="title">Добавить JSON по URL</h3>
      <p class="muted">Вставьте путь к файлу в репозитории (например, <code>/data/otkrovenie_1.json</code> или полный URL).</p>
      <input id="urlInput" type="url" placeholder="/otkrovenie_1.json" style="width:100%;margin:8px 0 12px" required>
      <menu style="display:flex; gap:8px; justify-content:flex-end">
        <button value="cancel" class="btn">Отмена</button>
        <button id="btnUrlSave" value="default" class="btn btn-primary">Добавить</button>
      </menu>
    </form>
  </dialog>

  <template id="tplCard">
    <div class="card">
      <div class="title"></div>
      <div class="muted" style="margin:.25rem 0 .75rem"></div>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn btn-primary show">Показать оглавление</button>
        <button class="btn open-file">Открыть JSON</button>
        <button class="btn remove">Удалить</button>
      </div>
    </div>
  </template>

<script>
;(()=>{
  /* ------------------ УТИЛИТЫ ------------------ */
  const $ = (s, r=document)=>r.querySelector(s);
  const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
  const uid = ()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
  const toastEl = $('#toast');
  function toast(msg, ms=1600){ toastEl.textContent = msg; toastEl.classList.remove('hidden'); setTimeout(()=>toastEl.classList.add('hidden'), ms); }

  /* ---------------- IndexedDB ------------------ */
  const DB = (()=>{
    const DB_NAME = 'libraryJSONv1';
    const DB_VER = 1;
    let dbp;
    function open(){
      if (dbp) return dbp;
      dbp = new Promise((res,rej)=>{
        const req = indexedDB.open(DB_NAME, DB_VER);
        req.onupgradeneeded = ()=>{
          const db = req.result;
          if (!db.objectStoreNames.contains('library')) db.createObjectStore('library',{keyPath:'id'});
          if (!db.objectStoreNames.contains('settings')) db.createObjectStore('settings',{keyPath:'key'});
        };
        req.onsuccess = ()=>res(req.result);
        req.onerror = ()=>rej(req.error);
      });
      return dbp;
    }
    async function tx(store, mode='readonly'){ const db = await open(); return db.transaction(store, mode).objectStore(store); }
    function p(req){ return new Promise((res,rej)=>{ req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error); }); }
    return {
      async put(store, val){ return p((await tx(store,'readwrite')).put(val)); },
      async get(store, key){ return p((await tx(store)).get(key)); },
      async getAll(store){ return p((await tx(store)).getAll()); },
      async del(store, key){ return p((await tx(store,'readwrite')).delete(key)); },
      async clear(store){ return p((await tx(store,'readwrite')).clear()); }
    }
  })();

  const Store = {
    async saveItem(item){ await DB.put('library', item); },
    async removeItem(id){ await DB.del('library', id); },
    async all(){ return await DB.getAll('library'); },
    async setSetting(key,val){ await DB.put('settings',{key,val}); },
    async getSetting(key){ const r = await DB.get('settings',key); return r?.val; },
    async clearAll(){ await DB.clear('library'); }
  };

  /* -------------- TELEGRAM адаптер -------------- */
  const TG = (()=>{
    let available = false; let WebApp = null; let user = { id:'local', name:'Гость' };
    function init(){
      if (window.Telegram && Telegram.WebApp){
        WebApp = Telegram.WebApp; available = true; WebApp.ready(); WebApp.expand();
        const u = WebApp.initDataUnsafe?.user; if (u) user = { id:String(u.id), name: u.username||[u.first_name,u.last_name].filter(Boolean).join(' ')||'Пользователь' };
        applyThemeFromTelegram(); WebApp.onEvent('themeChanged', applyThemeFromTelegram);
      }
    }
    function applyThemeFromTelegram(){ const cs = Telegram.WebApp.colorScheme; if ($('input[name="theme"][value="auto"]').checked) document.body.setAttribute('data-theme', cs==='dark'?'dark':'light'); }
    return { init };
  })();

  /* ------------------- СОСТОЯНИЕ ------------------- */
  const detailsHost = $('#details');
  const mainMenu = $('#mainMenu');
  const menuList = mainMenu.querySelector('.menu-list');
  mainMenu.querySelector('button').addEventListener('click', ()=>{ const open = menuList.style.display!=='none'; menuList.style.display = open?'none':'block'; });
  document.addEventListener('click', (e)=>{ if (!mainMenu.contains(e.target)) menuList.style.display='none'; });

  $('#btnSettings').addEventListener('click', ()=> showView('settings'));
  $('#btnClearAll').addEventListener('click', clearAll);
  $('#btnClearAll2').addEventListener('click', clearAll);

  $('#fileInput').addEventListener('change', async (e)=>{ await importJSONFiles(Array.from(e.target.files||[])); e.target.value=''; });
  $('#btnAddUrl').addEventListener('click', openUrlDialog);
  $('#btnAddUrl2').addEventListener('click', openUrlDialog);
  $('#btnLoadIndex').addEventListener('click', loadIndexJson);
  $('#btnLoadIndex2').addEventListener('click', loadIndexJson);
  $('#appLogo').addEventListener('click', ()=> showView('library'));
  $('#searchInput').addEventListener('input', refreshLibrary);

  function showView(name){
    $('#view-library').classList.toggle('hidden', name!=='library');
    $('#view-settings').classList.toggle('hidden', name!=='settings');
  }

  async function clearAll(){ if(!confirm('Удалить всю библиотеку?')) return; await Store.clearAll(); detailsHost.innerHTML = '<span class="muted">Библиотека пуста.</span>'; await refreshLibrary(); toast('Очищено'); }

  /* ------------------- ИМПОРТ ------------------- */
  async function importJSONFiles(files){
    let ok = 0, bad = 0;
    for (const file of files){
      try{
        const text = await file.text();
        const data = JSON.parse(text);
        const item = normalizeJSONItem(data, { id: 'json-'+uid(), source:'Локальный файл', path:file.name });
        await Store.saveItem(item); ok++;
      }catch{ bad++; }
    }
    await refreshLibrary();
    toast(`Импортировано: ${ok}${bad?`, ошибок: ${bad}`:''}`);
  }

  function normalizeJSONItem(json, meta={}){
    const title = json.title || json.book_title || 'Без названия';
    const chapters = Array.isArray(json.chapters)? json.chapters.length : 0;
    return {
      id: meta.id || json.content_id || 'json-'+uid(),
      type: 'json-book',
      title,
      content_id: json.content_id||null,
      chapters,
      pages: json.pages||null,
      source: meta.source||'JSON',
      path: meta.path||null,
      created: Date.now(),
      json
    };
  }

  async function openUrlDialog(){
    const dlg = $('#dlgUrl'); const input = $('#urlInput'); input.value = '';
    dlg.showModal();
    dlg.addEventListener('close', async function onClose(){
      dlg.removeEventListener('close', onClose);
      if (dlg.returnValue !== 'default') return;
      const url = input.value.trim(); if (!url) return;
      try{
        const res = await fetch(url, {cache:'no-store'});
        const data = await res.json();
        const item = normalizeJSONItem(data, { id:'json-'+uid(), source:'URL', path:url });
        await Store.saveItem(item); await refreshLibrary(); toast('Добавлено');
      }catch(err){ console.error(err); toast('Не удалось загрузить JSON'); }
    });
  }

  async function loadIndexJson(){
    // Ожидаемый формат library.json: [{ title, url }, ...]
    const url = prompt('Путь к library.json (например, /library.json):','/library.json'); if (!url) return;
    try{
      const res = await fetch(url, {cache:'no-store'}); const list = await res.json();
      let added = 0;
      for (const row of list){
        try{
          const r = await fetch(row.url, {cache:'no-store'}); const data = await r.json();
          const item = normalizeJSONItem(data, { id:'json-'+uid(), source:'index', path:row.url });
          await Store.saveItem(item); added++;
        }catch{ /* пропускаем */ }
      }
      await refreshLibrary(); toast(`Импортировано из index: ${added}`);
    }catch{ toast('Не удалось загрузить library.json'); }
  }

  /* ------------------- РЕНДЕР ------------------- */
  async function refreshLibrary(){
    const q = ($('#searchInput').value||'').toLowerCase().trim();
    const list = await Store.all();
    const lib = $('#libraryList'); lib.innerHTML = '';
    const filtered = list.filter(it=> !q || (it.title||'').toLowerCase().includes(q) || (it.path||'').toLowerCase().includes(q));
    filtered.sort((a,b)=> (b.created||0)-(a.created||0));
    $('#emptyLibraryNote').classList.toggle('hidden', !!filtered.length);
    for (const it of filtered){ renderCard(it, lib); }
  }

  function renderCard(item, host){
    const frag = document.importNode($('#tplCard').content, true);
    const el = frag.firstElementChild;
    el.querySelector('.title').textContent = item.title;
    el.querySelector('.muted').textContent = `${item.source||'JSON'}${item.pages?` • стр. ${item.pages}`:''}${item.chapters?` • глав: ${item.chapters}`:''}`;
    el.querySelector('.show').addEventListener('click', ()=> showDetails(item));
    el.querySelector('.open-file').addEventListener('click', ()=> openJSON(item));
    el.querySelector('.remove').addEventListener('click', async ()=>{ if(!confirm('Удалить из библиотеки?')) return; await Store.removeItem(item.id); await refreshLibrary(); if (detailsHost.dataset.id===item.id) detailsHost.innerHTML='<span class="muted">Книга удалена.</span>'; });
    host.appendChild(el);
  }

  function showDetails(item){
    detailsHost.dataset.id = item.id;
    const j = item.json || {};
    const meta = `
      <div class="muted" style="margin-bottom:8px">content_id: <b>${j.content_id||'—'}</b> • pages: <b>${j.pages||'—'}</b> • chapters: <b>${(j.chapters||[]).length}</b></div>
    `;
    const chapters = Array.isArray(j.chapters) ? j.chapters : [];
    if (!chapters.length){ detailsHost.innerHTML = meta + '<div class="muted">Глав нет (или неверный формат JSON).</div>'; return; }
    const ul = document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0';
    chapters.forEach((ch, i)=>{
      const li = document.createElement('li'); li.style.margin='8px 0';
      const h = document.createElement('div'); h.innerHTML = `<b>${escapeHtml(ch.title||`Глава ${i+1}`)}</b> <span class="muted">(стр. ${ch.start_page||'—'})</span>`;
      li.appendChild(h);
      const subs = Array.isArray(ch.subsections)? ch.subsections: [];
      if (subs.length){
        const ul2 = document.createElement('ul'); ul2.style.margin='6px 0 0 14px';
        subs.forEach(ss=>{
          const li2 = document.createElement('li');
          li2.innerHTML = `${escapeHtml(ss.title||'Подзаголовок')} <span class="muted">(стр. ${ss.start_page||'—'})</span>`;
          ul2.appendChild(li2);
        });
        li.appendChild(ul2);
      }
      ul.appendChild(li);
    });
    detailsHost.innerHTML = meta; detailsHost.appendChild(ul);
  }

  function openJSON(item){
    const blob = new Blob([JSON.stringify(item.json, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = (item.title||'book')+'.json'; a.click();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }

  function escapeHtml(s=''){ return s.replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

  /* ----------- PWA (минимальная обёртка) ----------- */
  (function makeManifest(){
    const manifest = { name:"КЛАДОВАЯ • Библиотека", short_name:"Библиотека", start_url:".", display:"standalone", background_color:"#EFE1CE", theme_color:"#B88B5A" };
    const blob = new Blob([JSON.stringify(manifest)],{type:'application/manifest+json'});
    const link = document.createElement('link'); link.rel='manifest'; link.href = URL.createObjectURL(blob); document.head.appendChild(link);
  })();

  /* ------------------- Boot ------------------- */
  async function boot(){
    TG.init();
    // Настройка темы
    const savedTheme = await Store.getSetting('theme')||'auto';
    $$('input[name="theme"]').forEach(r=> r.checked = (r.value===savedTheme));
    applyTheme(savedTheme);
    $$('input[name="theme"]').forEach(r=> r.addEventListener('change', ()=>{ const v = $$('input[name="theme"]').find(x=>x.checked)?.value||'auto'; applyTheme(v); Store.setSetting('theme', v); }));

    // Предзагрузка примера (можно убрать): если в репозитории лежит /otkrovenie_1.json
    try{
      const probe = await fetch('./otkrovenie_1.json', {cache:'no-store'});
      if (probe.ok){
        const data = await probe.json();
        const existing = (await Store.all()).find(x=> x.json?.content_id === data.content_id);
        if (!existing){ await Store.saveItem(normalizeJSONItem(data,{id:'json-'+uid(), source:'repo', path:'./otkrovenie_1.json'})); }
      }
    }catch{/* игнор */}

    await refreshLibrary();
    showView('library');
  }

  function applyTheme(v){
    if (v==='auto'){
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; document.body.setAttribute('data-theme', prefersDark?'dark':'light');
    } else { document.body.setAttribute('data-theme', v); }
  }

  document.addEventListener('DOMContentLoaded', boot);
})();
</script>
</body>
</html>
